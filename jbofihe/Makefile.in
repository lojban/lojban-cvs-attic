# $Header$
#
# Makefile for parser/glosser
#
# COPYRIGHT
#

PREFIX=@@PREFIX@@
EXEDIR=$(PREFIX)/bin
LIBDIR=$(PREFIX)/lib/jbofihe
DICTNAME=smujmaji.dat
DICTIONARY=$(LIBDIR)/$(DICTNAME)
MANDIR=$(PREFIX)/man/man1

INSTALL=@@INSTALLPROG@@
CC=gcc
CFLAGS= @@OPTDEBUG@@ -DHAVE_MMAP=1 -DDEFAULT_DICTIONARY=\"$(DICTIONARY)\"

OBJS2 = main.o lex1.o lex2.o cmavotab.o rpc_tab.o functions.o \
        categ.o nonterm.o tree.o translate.o latex.o \
        properties.o conversion.o terms.o memory.o tenses.o \
	output.o textout.o htmlout.o connect.o stag.o latexblk.o \
        relative.o textblk.o errorscan.o canonluj.o lujvofns.o

SRCS2 = $(OBJS2:%.o=%.c)

CM_OBJS = cm_gather.o cm_output.o cm_main.o cm_translate.o cm_scan.o

CM_SRCS = $(CM_OBJS:%.o=%.c)

jbofihe : $(OBJS2)
	$(CC) $(CFLAGS) -o jbofihe $(OBJS2)

all : dictionary progs

progs : jbofihe cmafihe jvocuhadju smujajgau

# Analyse shift/reduce conflicts in the grammar
conflict :
	perl terminator.pl < rpc2x.y > rpc2x_noet.y
	bison -v rpc2x_noet.y

%.o : %.c
	$(CC) $(CFLAGS) -c $<

%.s : %.c
	$(CC) $(CFLAGS) -S $<

rpc2x_nc.y : rpc2x.y uncom
	./uncom < rpc2x.y > rpc2x_nc.y

rpc2x_act.y nonterm.h nonterm.c : rpc2x_nc.y
	perl ./action.perl < rpc2x_nc.y > rpc2x_act.y

rpc_tab.c rpc_tab.h : rpc2x_act.y
	bison -v -d rpc2x_act.y
	mv rpc2x_act.tab.c rpc_tab.c
	mv rpc2x_act.tab.h rpc_tab.h

stag.c : stag.tab.c
	sed -e 's/YYSTYPE/STAG_YYSTYPE/g;' < stag.tab.c > stag.c

stag.h : stag.tab.h
	sed -e 's/YYSTYPE/STAG_YYSTYPE/g;' < stag.tab.h > stag.h

stag.tab.c stag.tab.h : stag.y
	bison -v -d -p stag_ stag.y

uncom : uncom.o

uncom.o : uncom.c
	$(CC) -O2 -c uncom.c

uncom.c : uncom.l
	flex -t uncom.l > uncom.c

translate.o : translate.c
	$(CC) $(CFLAGS) -c translate.c

smujajgau : smujajgau.o canonluj.o
	$(CC) $(CFLAGS) -o smujajgau smujajgau.o canonluj.o

smujajgau.o : smujajgau.c
	$(CC) $(CFLAGS) -c smujajgau.c

dictionary : smujajgau
	perl giscolon.pl < @@WORD-LISTS@@/gismu > gismu.dict
	perl cmacolon.pl < @@WORD-LISTS@@/cmavo > cmavo.dict
	perl lujvod.pl < @@WORD-LISTS@@/lujvo-list > lujvo.dict
	perl oblik.pl < @@WORD-LISTS@@/oblique.key > oblik.dict
	perl raf4l.pl < @@WORD-LISTS@@/gismu > raf4l.dict
	perl rafobl.pl "@@WORD-LISTS@@/" > rafobl.dict
	perl rafsid.pl < @@WORD-LISTS@@/rafsi > rafsid.dict
	perl rafsig.pl < @@WORD-LISTS@@/rafsi > rafsig.dict
	perl raf4lg.pl < @@WORD-LISTS@@/gismu > raf4lg.dict
	perl selmao.pl < @@WORD-LISTS@@/cmavo > selmao.dict
	perl lujvop.pl "@@WORD-LISTS@@/" < @@WORD-LISTS@@/lujvo-list > lujvop.dict
	perl noralujv.pl "@@WORD-LISTS@@/" > noralujv.dict
	./smujajgau $(DICTNAME) gismu.dict cmavo.dict lujvo.dict oblik.dict \
		raf4l.dict rafobl.dict rafsid.dict rafsig.dict raf4lg.dict \
		noralujv.dict selmao.dict \
		extradict places.dat patterns

dictupdate : $(DICTNAME)

$(DICTNAME) : extradict places.dat patterns
	./smujajgau $(DICTNAME) extradict places.dat patterns

cmafihe : $(CM_OBJS)
	$(CC) $(CFLAGS) -o cmafihe $(CM_OBJS)

cm_scan.c : cm_scan.l
	flex -t cm_scan.l > cm_scan.c

jvocuhadju : jvocuhadju.o lujvofns.o

jvocuhadju.o : jvocuhadju.c version.h

smujajgau.o : smujajgau.c version.h

canonluj.o : canonluj.inc

canonluj.inc:
	perl canonluj.pl < @@WORD-LISTS@@/gismu > canonluj.inc

clean:
	-rm *.output *.tab.* *.o jbofihe uncom smujajgau *.dict rpc2x_nc.y rpc2x_act.y nonterm.*

# Specify in this perverse way so that the $-Name construction doesn't get replaced on checkout!

version.h : version.txt
	sed -e 's/[$$]Name: \(.*\) [$$]/\1/;' < version.txt > version.h

depend:
	gcc -MM $(SRCS2) $(CM_SRCS) > .depend

install : jbofihe smujajgau cmafihe jvocuhadju $(DICTNAME)
	$(INSTALL) -s -m 755 jbofihe smujajgau cmafihe jvocuhadju $(EXEDIR)
	$(INSTALL) -m 755 -d $(LIBDIR)
	$(INSTALL) -m 644 $(DICTNAME) $(LIBDIR)/$(DICTNAME)
	$(INSTALL) -m 644 jbofihe.1 cmafihe.1 smujajgau.1 jvocuhadju.1 $(MANDIR)

## Include the dependency info below.

main.o: main.c nodes.h nonterm.h functions.h output.h version.h
lex1.o: lex1.c cmavotab.h nodes.h nonterm.h functions.h output.h \
 lujvofns.h
lex2.o: lex2.c functions.h nonterm.h nodes.h output.h cmavotab.h \
 rpc_tab.h
cmavotab.o: cmavotab.c cmavotab.h rpc_tab.h
rpc.tab.o: rpc.tab.c nodes.h nonterm.h functions.h output.h
functions.o: functions.c functions.h nonterm.h nodes.h output.h \
 rpc_tab.h
categ.o: categ.c nodes.h nonterm.h rpc_tab.h functions.h output.h \
 stag.h
nonterm.o: nonterm.c
tree.o: tree.c nonterm.h functions.h nodes.h output.h cmavotab.h \
 rpc_tab.h
translate.o: translate.c functions.h nonterm.h nodes.h output.h \
 canonluj.h
latex.o: latex.c functions.h nonterm.h nodes.h output.h latex.h
properties.o: properties.c nodes.h nonterm.h functions.h output.h
conversion.o: conversion.c nodes.h nonterm.h functions.h output.h \
 rpc_tab.h cmavotab.h
terms.o: terms.c functions.h nonterm.h nodes.h output.h rpc_tab.h \
 cmavotab.h
memory.o: memory.c functions.h nonterm.h nodes.h output.h
tenses.o: tenses.c rpc_tab.h nonterm.h functions.h nodes.h output.h
output.o: output.c nodes.h nonterm.h functions.h output.h cmavotab.h \
 rpc_tab.h
textout.o: textout.c functions.h nonterm.h nodes.h output.h
htmlout.o: htmlout.c functions.h nonterm.h nodes.h output.h
connect.o: connect.c nodes.h nonterm.h functions.h output.h rpc_tab.h \
 cmavotab.h
stag.o: stag.c
latexblk.o: latexblk.c functions.h nonterm.h nodes.h output.h latex.h
relative.o: relative.c nodes.h nonterm.h rpc_tab.h functions.h \
 output.h cmavotab.h
textblk.o: textblk.c functions.h nonterm.h nodes.h output.h
errorscan.o: errorscan.c functions.h nonterm.h nodes.h output.h
canonluj.o: canonluj.c canonluj.h canonluj.inc
lujvofns.o: lujvofns.c lujvofns.h
cm_gather.o: cm_gather.c cm.h
cm_output.o: cm_output.c cm.h
cm_main.o: cm_main.c cm.h version.h
cm_translate.o: cm_translate.c cm.h
cm_scan.o: cm_scan.c cm.h
